<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Панель популярности</title>
<style>
  body { font-family: Arial, sans-serif; margin: 30px; background: #f9f9f9; }
  h2 { margin-top: 20px; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 20px; background: #fff; border-radius: 6px; overflow: hidden; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  canvas { background: #fff; border-radius: 6px; padding: 10px; }
</style>
</head>
<body>

<h1>Панель популярности сайта</h1>

<h2>Топ страниц</h2>
<table id="topPagesTable">
  <thead><tr><th>Страница</th><th>Посещений</th></tr></thead>
  <tbody></tbody>
</table>

<h2>Топ разделов</h2>
<table id="topSectionsTable">
  <thead><tr><th>Раздел</th><th>Посещений</th></tr></thead>
  <tbody></tbody>
</table>

<h2>Динамика посещаемости по дням</h2>
<canvas id="visitsChart" width="800" height="400"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function(){
  const sheetId = "ВАШ_ID_ТАБЛИЦЫ";
  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

  // Получаем данные из таблицы
  const res = await fetch(csvUrl);
  const text = await res.text();
  const rows = text.trim().split("\n").slice(1).map(r => r.split(","));

  // Подсчёт посещений по странице и разделу
  const pageCounts = {};
  const sectionCounts = {};
  const dailyCounts = {};

  rows.forEach(r=>{
    const date = new Date(r[0]).toISOString().slice(0,10); // yyyy-mm-dd
    const page = r[1];
    const section = r[6] || "Не указан";

    pageCounts[page] = (pageCounts[page]||0)+1;
    sectionCounts[section] = (sectionCounts[section]||0)+1;
    dailyCounts[date] = (dailyCounts[date]||0)+1;
  });

  // Функция для заполнения таблицы
  function fillTable(id,obj){
    const tbody = document.getElementById(id).querySelector("tbody");
    const sorted = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    tbody.innerHTML = "";
    sorted.forEach(([k,v])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
      tbody.appendChild(tr);
    });
  }

  fillTable("topPagesTable", pageCounts);
  fillTable("topSectionsTable", sectionCounts);

  // График динамики по дням
  const ctx = document.getElementById("visitsChart").getContext("2d");
  new Chart(ctx,{
    type: "line",
    data: {
      labels: Object.keys(dailyCounts).sort(),
      datasets: [{
        label: "Посещений в день",
        data: Object.keys(dailyCounts).sort().map(d=>dailyCounts[d]),
        borderColor: "blue",
        backgroundColor: "rgba(0,0,255,0.1)",
        fill:true
      }]
    },
    options: { responsive:true, plugins:{legend:{display:true}} }
  });

})();
</script>
</body>
</html>
